你要看这个nan 从何而来
外界层面（不是我导致的）：
----交易量因子 (如换手率): 原始数据中的NaN代表“非交易”，保留NaN。 
-----变化率因子 (如利润增长率): 计算过程中因“上市未满一年”或“出现亏损”而产生的NaN，是逻辑的一部分，保留NaN
我代码导致的（比如因子计算）：
------场景：计算过程中因“分母无意义”而产生的NaN，是风控的一部分，保留NaN。



分类
数据类型	                  金融属性	        停牌日真实状态	       推荐处理方式	             背后逻辑
成交额/换手率	              交易量 (Flow)	    交易活动为 0	             NaN	  忠于“无交易发生”的事实，避免污染滚动计算
价格/市值	                  状态量 (State)	    价格状态被维持	           ffill	  忠于“价值连续”的假设，为指标计算提供连续数据






这套模型适用于你未来遇到的任何因子，希望能成为你进行因子研究时的“检查清单”。

规则一：【原始数据层】—— 尊重事实

    交易量 (Flow): amount, turnover_rate。非交易日必须为 NaN。

    状态量 (State): price, total_assets。财报等时点数据，在日度化时应使用 ffill 来保证状态的连续性。

规则二：【因子计算层】—— 编码逻辑

    因子计算过程（如shift, where, 除法）可能会产生新的、有金融学意义的 NaN（例如：上市未满一年、出现亏损、分母为0等）。

    行动： 保留这些NaN。它们是你因子定义和风控逻辑的一部分。

规则三：【因子测试层 (IC, 分层)】—— 求“真”

    目标： 评估因子本身最纯粹、最真实的预测能力。

    行动： 绝不填充 (NEVER FILL)。将上一步计算出的、可能包含NaN的因子直接用于测试。让测试工具（如alphalens或你自己的脚本）通过**自动排除NaN**的方式，在有效数据范围内进行计算。

规则四：【策略应用层 (回测)】—— 求“全”

    目标： 运行一个完整的、需要处理整个股票池的投资组合构建流程。

    行动： 这是唯一可以考虑填充的阶段。它是一个建模选择 (Modeling Choice)，而非数据清洗。

    稳健默认选项： 填充横截面中位数 (fillna(median))，代表“赋予其市场平均水平的特征”。

特定逻辑选项： 填充0，代表“赋予其市场最差的评级”（比如对于流动性因子）。